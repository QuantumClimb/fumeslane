# Stripe Webhook Not Processing - Critical Issue

## Problem Summary
Stripe webhook is NOT updating orders from PENDING to CONFIRMED after successful payments. No confirmation emails are being sent. This has been ongoing since Nov 13, 2025.

## Current State
- **Payments**: Successfully processing in Stripe (all test payments show as PAID)
- **Orders**: Created in database with correct sessionId
- **Webhook Events**: Generated by Stripe (checkout.session.completed events exist)
- **Order Status**: Stuck at PENDING (should be CONFIRMED)
- **Emails**: Not being sent automatically
- **Manual Fix**: Works perfectly (fix-order-and-send-emails.mjs successfully updates orders and sends emails)

## Timeline
- **Nov 9, 2025**: Webhook working correctly (orders ORD-20251109-123, ORD-20251109-551 auto-confirmed)
- **Nov 13, 2025**: Webhook stopped working (orders ORD-20251113-401, ORD-20251113-762 stayed PENDING)
- **Nov 15, 2025**: Multiple test orders all staying PENDING despite successful Stripe payments

## Recent Test Orders (All Failed)
1. **ORD-20251115-66** - Latest test (8:42:53 pm) - PENDING ❌
   - Stripe Event: evt_1STl9l4AYllAtAxryWgFfH6f
   - Session: cs_test_a1NFfAdd7eA1DIapIq0h9zPIIaY3Te6RZ3LeCvQJQ7FIruPGfPMmKTVWl7
   
2. **ORD-20251115-859** - Test (8:27:39 pm) - PENDING ❌
   - Stripe Event: evt_1STkv14AYllAtAxrVJpZMgEW
   
3. **ORD-20251115-129** - Test (8:02:14 pm) - PENDING ❌
   - Stripe Event: evt_1STkWQ4AYllAtAxrovkbGj4k

## Technical Details

### Environment
- **Platform**: Vercel Serverless
- **Framework**: Express.js (wrapped as serverless function)
- **Database**: Neon PostgreSQL via Prisma ORM
- **Email Service**: Resend (domain verified: namastecurry.house)
- **Payment**: Stripe

### Webhook Configuration
- **URL**: https://www.namastecurry.house/api/stripe/webhook
- **Webhook ID**: we_1SQshX4AYllAtAxreGYjEA8w
- **Webhook Secret**: whsec_qMaoX6r6vFhV18e5PWI6smNhO6oUi6gp (configured in Vercel env vars)
- **Events**: checkout.session.completed

### Files
1. **api/stripe/webhook.js** - Dedicated Vercel serverless function
2. **server/index.js** - Main Express server (has webhook endpoint too)
3. **vercel.json** - Routing configuration

### Previous Errors Identified
1. **Initial Error** (from logs screenshot):
   ```
   POST 400 /api/stripe/webhook
   Webhook signature verification failed: Webhook payload must be provided as a string or a Buffer
   ```
   - **Cause**: express.raw() middleware not working in Vercel serverless
   - **Fix Attempted**: Created dedicated serverless function with manual raw body reading

2. **Second Error** (after first fix):
   ```
   FUNCTION_INVOCATION_FAILED
   ```
   - **Cause**: React component imports (CustomerConfirmationEmail, OwnerNotificationEmail) not compatible with serverless
   - **Fix Attempted**: Replaced with plain HTML email templates

## Current Status
- Webhook endpoint responds correctly to GET (returns "Method not allowed")
- Latest deployment: 6 minutes ago (namastecurry-jcpghlewi-quantum-climbs-projects.vercel.app)
- No visible errors in endpoint test
- But orders still not updating

## What Works
✅ Payment processing (Stripe)
✅ Order creation (database)
✅ Email sending (when triggered manually)
✅ Database updates (when done manually)
✅ Webhook endpoint exists and responds

## What Doesn't Work
❌ Webhook receiving/processing Stripe events
❌ Automatic order status updates
❌ Automatic email sending

## Questions for Investigation
1. **Is Stripe actually calling the webhook?** 
   - Need to check Stripe webhook delivery logs
   - User cannot access Stripe Dashboard
   
2. **Is the webhook function executing?**
   - Vercel logs command times out
   - No way to see console.log output from webhook
   
3. **Is there a routing issue?**
   - vercel.json has explicit route for /api/stripe/webhook
   - Endpoint responds to requests
   
4. **Are environment variables set correctly in Vercel?**
   - STRIPE_SECRET_KEY
   - STRIPE_WEBHOOK_SECRET
   - RESEND_API_KEY
   - DATABASE_URL
   - TEST_MODE=true
   - TEST_MODE_EMAIL=juncando@gmail.com
   - TEST_MODE_OWNER_EMAIL=namastecurrylisboa@gmail.com

## Code Structure

### api/stripe/webhook.js (Current Implementation)
```javascript
// Disable automatic body parsing
export const config = {
  api: {
    bodyParser: false,
  },
};

// Manual raw body reading
async function getRawBody(req) {
  return new Promise((resolve, reject) => {
    const chunks = [];
    req.on('data', (chunk) => chunks.push(chunk));
    req.on('end', () => resolve(Buffer.concat(chunks)));
    req.on('error', reject);
  });
}

// Main handler
export default async function handler(req, res) {
  // 1. Read raw body
  // 2. Verify Stripe signature
  // 3. Process checkout.session.completed event
  // 4. Update order to CONFIRMED
  // 5. Send emails
}
```

### vercel.json
```json
{
  "rewrites": [
    {
      "source": "/api/stripe/webhook",
      "destination": "/api/stripe/webhook"
    },
    {
      "source": "/api/:path*",
      "destination": "/api"
    },
    {
      "source": "/(.*)",
      "destination": "/index.html"
    }
  ]
}
```

## Possible Issues to Check
1. **Vercel Environment Variables**: Are they all set correctly?
2. **Stripe Webhook Endpoint**: Is Stripe sending to the correct URL?
3. **Signature Verification**: Is the webhook secret correct?
4. **Body Parsing**: Is the raw body being read correctly?
5. **Database Connection**: Is Prisma connecting in serverless context?
6. **Async Issues**: Are promises being awaited properly?
7. **Error Swallowing**: Are errors being caught and hidden?
8. **Vercel Function Timeout**: Is the function timing out?
9. **Cold Start Issues**: First request after deployment?

## Manual Workaround (Currently Working)
```bash
node scripts/fix-order-and-send-emails.mjs <orderId>
```
This successfully:
- Updates order to CONFIRMED
- Sends customer confirmation email
- Sends owner notification email

## Request for Help
We need assistance to:
1. Debug why the webhook is not processing events
2. Access Vercel function logs to see what's happening
3. Verify Stripe webhook delivery status
4. Fix the webhook so orders are automatically confirmed and emails sent
5. Test the complete flow end-to-end

## Expected Behavior
When a customer completes payment:
1. Stripe sends checkout.session.completed event to webhook
2. Webhook verifies signature
3. Webhook updates order status to CONFIRMED
4. Webhook sends confirmation email to customer (juncando@gmail.com in TEST_MODE)
5. Webhook sends notification email to restaurant (namastecurrylisboa@gmail.com in TEST_MODE)
6. Returns 200 OK to Stripe

## Actual Behavior
1. Stripe sends event (confirmed)
2. Webhook... ❓ (unknown - no logs)
3. Order stays PENDING
4. No emails sent
5. No errors visible

---

**Priority**: CRITICAL - Production issue affecting customer experience
**Impact**: Customers paying but not receiving confirmations, orders not being processed
**Duration**: 2+ days
**Status**: Multiple fix attempts made, issue persists
